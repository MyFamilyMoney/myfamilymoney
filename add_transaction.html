<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;900&display=swap');
        body { font-family: 'Kanit', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 flex items-center justify-center">
    <div class="max-w-md w-full bg-white p-6 rounded-[2.5rem] shadow-2xl border border-gray-100">
        <div class="flex bg-gray-100 p-1 rounded-2xl mb-6">
            <button onclick="changeAcc('Circular')" id="btnCirc" class="flex-1 py-2 rounded-xl font-bold bg-white shadow text-blue-600 transition-all">üí≥ ‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô</button>
            <button onclick="changeAcc('Savings')" id="btnSave" class="flex-1 py-2 rounded-xl font-bold text-gray-400 transition-all">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö/‡∏≠‡∏≠‡∏°</button>
        </div>
        <div id="typeToggle" class="grid grid-cols-2 gap-2 mb-6">
            <button onclick="changeType('Income')" id="typeInc" class="py-3 rounded-2xl font-black border-2 border-green-500 bg-green-50 text-green-600 shadow-sm transition-all">üî∫ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
            <button onclick="changeType('Expense')" id="typeExp" class="py-3 rounded-2xl font-black border-2 border-gray-100 text-gray-400 transition-all">üîª ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
        </div>
        
        <form id="transForm" class="space-y-4">
            <div id="catArea" class="space-y-3">
                <select id="mainCat" onchange="filterSub()" required class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 outline-none"><option value="">-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å --</option></select>
                <select id="catId" required class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 outline-none"><option value="">-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option></select>
            </div>
            
            <div id="amtBox" class="bg-blue-50/50 p-4 rounded-3xl border-2 border-dashed border-blue-200">
                <p class="text-center text-[10px] text-blue-400 font-bold mb-1 uppercase">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                <input type="number" id="amount" placeholder="0.00" required step="any" class="w-full bg-transparent text-4xl text-center font-black text-gray-800 outline-none">
            </div>

            <div class="space-y-2">
                <label class="flex items-center justify-center gap-2 w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 text-gray-500 font-bold cursor-pointer hover:bg-gray-100 transition">
                    <span id="camLabel">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</span>
                    <input type="file" id="imageInput" accept="image/*" capture="camera" class="hidden" onchange="previewImage(this)">
                </label>
                <div id="imgPreview" class="hidden relative">
                    <img id="preview" class="w-full h-48 object-cover rounded-2xl border shadow-inner">
                    <button type="button" onclick="removeImage()" class="absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full text-xs shadow-lg font-bold">‚úï ‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
                </div>
            </div>

            <input type="text" id="note" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 outline-none">
            
            <button type="submit" id="saveBtn" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-bold text-xl shadow-lg active:scale-95 transition-all mt-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button type="button" onclick="window.location.href='dashboard.html'" class="w-full text-gray-400 text-sm mt-2 text-center font-bold">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </form>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzZZpDPyHZjKTm4IdVsHSat6wuzSaxsV-6EZGnF-YCDar632A9DV0ZULzXcNrLwGLB3/exec"; // ‚ö†Ô∏è ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        let currentAcc = 'Circular', currentType = 'Income', allCats = [], base64Image = "";

        async function load() { const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'get_categories' }) }); const data = await res.json(); if (data.status === 'success') { allCats = data.categories; renderOptions(); } }
        
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    base64Image = e.target.result;
                    document.getElementById('preview').src = base64Image;
                    document.getElementById('imgPreview').classList.remove('hidden');
                    document.getElementById('camLabel').innerText = "‚úÖ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage() {
            base64Image = "";
            document.getElementById('imageInput').value = "";
            document.getElementById('imgPreview').classList.add('hidden');
            document.getElementById('camLabel').innerText = "üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à";
        }

        function changeAcc(acc) { currentAcc = acc; renderOptions(); }
        function changeType(type) { currentType = type; renderOptions(); }
        
        function renderOptions() { 
            const isSave = currentAcc === 'Savings';
            document.getElementById('btnCirc').className = !isSave ? "flex-1 py-2 rounded-xl font-bold bg-white shadow text-blue-600" : "flex-1 py-2 rounded-xl font-bold text-gray-400";
            document.getElementById('btnSave').className = isSave ? "flex-1 py-2 rounded-xl font-bold bg-white shadow text-green-600" : "flex-1 py-2 rounded-xl font-bold text-gray-400";
            const catArea = document.getElementById('catArea');
            if (isSave) {
                const savCats = allCats.filter(c => c.parent === '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö');
                catArea.innerHTML = `<select id="catId" required class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 outline-none">${savCats.map(c => `<option value="${c.id}">${currentType === 'Expense' ? '‡∏Ç‡∏≤‡∏¢/‡∏ñ‡∏≠‡∏ô ' + c.name : c.name}</option>`).join('')}</select>`;
            } else {
                catArea.innerHTML = `<select id="mainCat" onchange="filterSub()" required class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 outline-none"><option value="">-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å --</option></select><select id="catId" required class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 outline-none"><option value="">-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option></select>`;
                const filtered = allCats.filter(c => c.parent !== '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö' && c.type === currentType);
                const uniqueParents = [...new Set(filtered.map(c => c.parent))];
                document.getElementById('mainCat').innerHTML += uniqueParents.map(p => `<option value="${p}">${p}</option>`).join('');
            }
        }

        function filterSub() { 
            const pName = document.getElementById('mainCat').value; 
            const subs = allCats.filter(c => c.parent === pName && c.type === currentType); 
            document.getElementById('catId').innerHTML = subs.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); 
        }

        document.getElementById('transForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            
            const user = JSON.parse(localStorage.getItem('userData'));
            const amt = Math.abs(parseFloat(document.getElementById('amount').value));
            const imgInput = document.getElementById('imageInput');

            const payload = {
                action: 'add_transaction',
                data: {
                    userId: user.userId, catId: document.getElementById('catId').value,
                    amount: currentType === 'Expense' ? -amt : amt, note: document.getElementById('note').value,
                    type: currentType, accType: currentAcc,
                    imageFile: base64Image, // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    imageName: imgInput.files[0] ? imgInput.files[0].name : ""
                }
            };

            await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
            window.location.href = 'dashboard.html';
        });
        window.onload = load;
    </script>
</body>
</html>
