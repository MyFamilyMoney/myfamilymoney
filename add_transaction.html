<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title><script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-md mx-auto bg-white p-6 rounded-[2.5rem] shadow-xl border">
        <h2 class="text-xl font-bold text-center mb-6 text-green-700">üí∞ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h2>
        
        <div class="flex bg-gray-100 p-1 rounded-2xl mb-6">
            <button onclick="changeType('Expense')" id="btnExp" class="flex-1 py-3 rounded-xl font-bold transition bg-white shadow text-red-600">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
            <button onclick="changeType('Income')" id="btnInc" class="flex-1 py-3 rounded-xl font-bold transition text-gray-400">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
        </div>

        <form id="transForm" class="space-y-4">
            <div>
                <label class="text-xs text-gray-400 ml-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å</label>
                <select id="mainCat" onchange="filterSubCategories()" required class="w-full p-4 border rounded-2xl bg-gray-50 outline-none focus:ring-2 focus:ring-green-500">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å --</option>
                </select>
            </div>

            <div>
                <label class="text-xs text-gray-400 ml-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢</label>
                <select id="catId" required class="w-full p-4 border rounded-2xl bg-gray-50 outline-none focus:ring-2 focus:ring-green-500">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
                </select>
            </div>

            <input type="number" id="amount" placeholder="0.00" required class="w-full p-4 border rounded-2xl text-3xl text-center font-black text-green-600">
            <input type="text" id="note" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥..." class="w-full p-4 border rounded-2xl bg-gray-50">
            
            <button type="submit" id="saveBtn" class="w-full bg-green-600 text-white py-5 rounded-3xl font-bold shadow-lg active:scale-95 transition text-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button type="button" onclick="window.location.href='dashboard.html'" class="w-full text-gray-400 py-2 text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </form>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyIWdQvflPwRlUZRXqXdEOOmCzxwDHzbcvI-qDhtITms1HqsgGwqhakv5Om4wRg1pON/exec";
        let currentType = 'Expense';
        let allCategories = [];

        async function loadCategories() {
            const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'get_categories' }) });
            const data = await res.json();
            if (data.status === 'success') {
                allCategories = data.categories;
                renderMainCategories();
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å (‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)
        function renderMainCategories() {
            const mainSelect = document.getElementById('mainCat');
            const filtered = allCategories.filter(c => c.type === currentType);
            const uniqueParents = [...new Set(filtered.map(c => c.parent))];
            
            mainSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å --</option>' + 
                uniqueParents.map(p => `<option value="${p}">${p}</option>`).join('');
            
            document.getElementById('catId').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>';
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        function filterSubCategories() {
            const selectedParent = document.getElementById('mainCat').value;
            const subSelect = document.getElementById('catId');
            const filteredSub = allCategories.filter(c => c.type === currentType && c.parent === selectedParent);
            
            subSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>' + 
                filteredSub.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        function changeType(type) {
            currentType = type;
            document.getElementById('btnInc').className = type === 'Income' ? "flex-1 py-3 rounded-xl font-bold bg-white shadow text-green-600" : "flex-1 py-3 rounded-xl font-bold text-gray-400";
            document.getElementById('btnExp').className = type === 'Expense' ? "flex-1 py-3 rounded-xl font-bold bg-white shadow text-red-600" : "flex-1 py-3 rounded-xl font-bold text-gray-400";
            renderMainCategories();
        }

        window.onload = loadCategories;

        document.getElementById('transForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('userData'));
            const payload = {
                action: 'add_transaction',
                data: {
                    userId: user.userId,
                    catId: document.getElementById('catId').value,
                    amount: document.getElementById('amount').value,
                    note: document.getElementById('note').value,
                    type: currentType
                }
            };
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
            const result = await res.json();
            if (result.status === 'success') { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); window.location.href = 'dashboard.html'; }
        });
    </script>
</body>
</html>
