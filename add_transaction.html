<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ - MyFamily Money</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .btn-active { background-color: #1e293b !important; color: white !important; border-color: #1e293b !important; shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .btn-inactive { background-color: white; color: #64748b; border-color: #e2e8f0; }
    </style>
</head>
<body class="min-h-screen pb-10">
    <div class="max-w-md mx-auto p-4 space-y-4">
        <div class="flex items-center gap-3 mb-2">
            <button onclick="window.location.href='dashboard.html'" class="p-2 bg-white rounded-full shadow-sm text-slate-400 active:scale-90 transition">‚ùÆ</button>
            <h1 class="text-xl font-bold text-slate-800">‚úö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h1>
        </div>

        <div class="bg-white p-2 rounded-[2rem] shadow-sm flex gap-2 border border-slate-50">
            <button id="btnCirc" onclick="selectAcc('Circular')" class="flex-1 py-4 rounded-[1.6rem] font-bold text-sm transition-all border btn-active">üîÑ ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô</button>
            <button id="btnSave" onclick="selectAcc('Savings')" class="flex-1 py-4 rounded-[1.6rem] font-bold text-sm transition-all border btn-inactive">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≠‡∏°</button>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button id="typeInc" onclick="selectType('Income')" class="py-4 rounded-3xl font-bold text-sm border-2 border-emerald-500 text-emerald-600 bg-white active:scale-95 transition-all">‚úö ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
            <button id="typeExp" onclick="selectType('Expense')" class="py-4 rounded-3xl font-bold text-sm border-2 border-rose-500 bg-rose-500 text-white shadow-md active:scale-95 transition-all">‚ûñ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm space-y-4 border border-slate-50">
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-widest">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="amount" placeholder="0.00" class="w-full p-4 bg-slate-50 rounded-3xl border-none outline-none text-3xl font-bold text-slate-800">
            </div>

            <div id="catArea">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                <select id="catId" class="w-full p-4 bg-slate-50 rounded-3xl border-none outline-none font-medium text-slate-600 appearance-none">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                </select>
            </div>

            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥</label>
                <input type="text" id="note" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." class="w-full p-4 bg-slate-50 rounded-3xl border-none outline-none font-medium">
            </div>

            <div class="pt-2">
                <label class="block w-full border-2 border-dashed border-slate-200 rounded-3xl p-4 text-center cursor-pointer hover:bg-slate-50 transition" id="dropArea">
                    <input type="file" id="imgInput" class="hidden" accept="image/*" onchange="handleImg(this)">
                    <div id="imgPreview" class="flex flex-col items-center gap-2">
                        <span class="text-2xl">üì∏</span>
                        <span class="text-[10px] font-bold text-slate-400 uppercase">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</span>
                    </div>
                </label>
            </div>

            <button id="submitBtn" onclick="submitData()" class="w-full bg-slate-800 text-white py-5 rounded-[2rem] font-bold text-lg shadow-xl active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwLWvfg86IeiMxjcGEyb4BeDyCgpvRJW0rP3rHejeZa_BCN5k9qleV1lcwz-CVQ2lWw/exec";
        let currentAcc = 'Circular';
        let currentType = 'Expense';
        let imgBase64 = null;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô/‡∏≠‡∏≠‡∏°)
        function selectAcc(val) {
            currentAcc = val;
            const bC = document.getElementById('btnCirc');
            const bS = document.getElementById('btnSave');
            if(val === 'Circular') {
                bC.className = "flex-1 py-4 rounded-[1.6rem] font-bold text-sm transition-all border btn-active";
                bS.className = "flex-1 py-4 rounded-[1.6rem] font-bold text-sm transition-all border btn-inactive";
            } else {
                bC.className = "flex-1 py-4 rounded-[1.6rem] font-bold text-sm transition-all border btn-inactive";
                bS.className = "flex-1 py-4 rounded-[1.6rem] font-bold text-sm transition-all border btn-active";
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏£‡∏±‡∏ö/‡∏à‡πà‡∏≤‡∏¢)
        function selectType(val) {
            currentType = val;
            const bI = document.getElementById('typeInc');
            const bE = document.getElementById('typeExp');
            if(val === 'Income') {
                bI.className = "py-4 rounded-3xl font-bold text-sm border-2 border-emerald-500 bg-emerald-500 text-white shadow-md transition-all";
                bE.className = "py-4 rounded-3xl font-bold text-sm border-2 border-rose-500 text-rose-600 bg-white transition-all";
            } else {
                bI.className = "py-4 rounded-3xl font-bold text-sm border-2 border-emerald-500 text-emerald-600 bg-white transition-all";
                bE.className = "py-4 rounded-3xl font-bold text-sm border-2 border-rose-500 bg-rose-500 text-white shadow-md transition-all";
            }
        }

        function handleImg(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imgBase64 = e.target.result;
                    document.getElementById('imgPreview').innerHTML = `<img src="${imgBase64}" class="h-20 w-auto rounded-xl mx-auto shadow-sm">`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function init() {
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'get_categories' }) });
                const data = await res.json();
                if(data.status === 'success') {
                    const sel = document.getElementById('catId');
                    data.categories.forEach(c => { sel.innerHTML += `<option value="${c.id}">${c.name} (${c.type})</option>`; });
                }
            } catch (e) { console.error(e); }
        }

        async function submitData() {
            const amount = document.getElementById('amount').value;
            const catId = document.getElementById('catId').value;
            if(!amount || !catId) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"); return; }

            const user = JSON.parse(localStorage.getItem('userData'));
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = "‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

            const payload = {
                action: 'add_transaction',
                data: {
                    userId: user.userId,
                    amount: currentType === 'Expense' ? -Math.abs(amount) : Math.abs(amount),
                    catId: catId,
                    note: document.getElementById('note').value,
                    accType: currentAcc,
                    imageFile: imgBase64
                }
            };

            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
                const result = await res.json();
                if(result.status === 'success') {
                    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                    window.location.href = 'dashboard.html';
                }
            } catch (e) { alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"); btn.disabled = false; btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"; }
        }

        window.onload = init;
    </script>
</body>
</html>
