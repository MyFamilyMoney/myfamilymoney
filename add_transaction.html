<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ - MyFamily</title><script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen p-4 flex items-center justify-center">
    <div class="max-w-md w-full bg-white p-6 rounded-[2.5rem] shadow-2xl border border-gray-100">
        
        <div class="flex bg-gray-100 p-1 rounded-2xl mb-6">
            <button onclick="changeAcc('Circular')" id="btnCirc" class="flex-1 py-2 rounded-xl font-bold bg-white shadow text-blue-600 transition-all">‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô</button>
            <button onclick="changeAcc('Savings')" id="btnSave" class="flex-1 py-2 rounded-xl font-bold text-gray-400 transition-all">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö/‡∏≠‡∏≠‡∏°</button>
        </div>

        <div id="typeToggle" class="grid grid-cols-2 gap-2 mb-6">
            <button onclick="changeType('Expense')" id="typeExp" class="py-3 rounded-2xl font-black border-2 border-red-500 bg-red-50 text-red-600 shadow-sm transition-all">
                üîª ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
            </button>
            <button onclick="changeType('Income')" id="typeInc" class="py-3 rounded-2xl font-black border-2 border-gray-200 text-gray-400 transition-all">
                üî∫ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö
            </button>
        </div>

        <form id="transForm" class="space-y-4">
            <div class="space-y-3">
                <select id="mainCat" onchange="filterSub()" required class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:border-blue-400 outline-none">
                    <option value="">-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å --</option>
                </select>
                <select id="catId" required class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:border-blue-400 outline-none">
                    <option value="">-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>
                </select>
            </div>

            <div class="bg-blue-50/50 p-4 rounded-3xl border-2 border-dashed border-blue-200">
                <p class="text-center text-[10px] text-blue-400 uppercase font-bold mb-1">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                <input type="number" id="amount" placeholder="0.00" required step="any"
                       class="w-full bg-transparent text-4xl text-center font-black text-gray-800 outline-none">
            </div>

            <input type="text" id="note" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." 
                   class="w-full p-4 border-2 border-gray-100 rounded-2xl bg-gray-50 focus:border-blue-400 outline-none">
            
            <button type="submit" id="saveBtn" 
                    class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-bold text-xl shadow-lg active:scale-95 transition-all mt-4">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
            <button type="button" onclick="window.location.href='dashboard.html'" class="w-full text-gray-400 text-sm mt-2">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </form>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxxR_ewzPI6qonh5tQNZz0o1Gek4M_ylU2jqXxlIXrHP0ns6ppC1hR9SXCIw6jY2PFF/exec";
        let currentAcc = 'Circular'; 
        let currentType = 'Expense'; 
        let allCats = [];

        async function load() {
            const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'get_categories' }) });
            const data = await res.json();
            if (data.status === 'success') { allCats = data.categories; renderOptions(); }
        }

        function changeAcc(acc) {
            currentAcc = acc;
            document.getElementById('btnCirc').className = acc === 'Circular' ? "flex-1 py-2 rounded-xl font-bold bg-white shadow text-blue-600" : "flex-1 py-2 rounded-xl font-bold text-gray-400";
            document.getElementById('btnSave').className = acc === 'Savings' ? "flex-1 py-2 rounded-xl font-bold bg-white shadow text-green-600" : "flex-1 py-2 rounded-xl font-bold text-gray-400";
            renderOptions();
        }

        function changeType(type) {
            currentType = type;
            const isExp = type === 'Expense';
            document.getElementById('typeExp').className = isExp ? "py-3 rounded-2xl font-black border-2 border-red-500 bg-red-50 text-red-600 shadow-sm" : "py-3 rounded-2xl font-black border-2 border-gray-100 text-gray-400";
            document.getElementById('typeInc').className = !isExp ? "py-3 rounded-2xl font-black border-2 border-green-500 bg-green-50 text-green-600 shadow-sm" : "py-3 rounded-2xl font-black border-2 border-gray-100 text-gray-400";
            renderOptions();
        }

        function renderOptions() {
            const mainSelect = document.getElementById('mainCat');
            const parentFilter = currentAcc === 'Savings' ? '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö' : null;
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö/‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢
            const filtered = allCats.filter(c => {
                const isAccMatch = parentFilter ? c.parent === parentFilter : c.parent !== '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö';
                return isAccMatch && c.type === currentType;
            });

            const uniqueParents = [...new Set(filtered.map(c => c.parent))];
            mainSelect.innerHTML = '<option value="">-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å --</option>' + 
                                  uniqueParents.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('catId').innerHTML = '<option value="">-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>';
        }

        function filterSub() {
            const parentName = document.getElementById('mainCat').value;
            const subSelect = document.getElementById('catId');
            const subs = allCats.filter(c => c.parent === parentName && c.type === currentType);
            subSelect.innerHTML = '<option value="">-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>' + 
                                 subs.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        document.getElementById('transForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('userData'));
            const amtInput = document.getElementById('amount').value;
            // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏•‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢"
            const finalAmount = currentType === 'Expense' ? -Math.abs(amtInput) : Math.abs(amtInput);

            const payload = { 
                action: 'add_transaction', 
                data: { 
                    userId: user.userId, 
                    catId: document.getElementById('catId').value, 
                    amount: finalAmount, 
                    note: document.getElementById('note').value, 
                    type: currentType,
                    accType: currentAcc 
                } 
            };
            document.getElementById('saveBtn').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
            window.location.href = 'dashboard.html';
        });
        window.onload = load;
    </script>
</body>
</html>
