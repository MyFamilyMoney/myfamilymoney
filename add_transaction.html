<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ - MyFamily Money</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background-color: #f8fafc; }
        .btn-active { background-color: #1e293b !important; color: white !important; border-color: #1e293b !important; }
        .btn-inactive { background-color: white; color: #94a3b8; border-color: #f1f5f9; }
    </style>
</head>
<body class="min-h-screen pb-10 text-slate-700">
    <div class="max-w-md mx-auto p-4 space-y-4">
        <div class="flex items-center gap-3 mb-2">
            <button onclick="window.location.href='dashboard.html'" class="p-2 bg-white rounded-full shadow-sm text-slate-400 active:scale-90 transition">‚ùÆ</button>
            <h1 class="text-xl font-bold">‚úö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h1>
        </div>

        <div class="bg-white p-2 rounded-[2rem] shadow-sm flex gap-2 border border-slate-50">
            <button id="btnCirc" onclick="selectAcc('Circular')" class="flex-1 py-4 rounded-[1.6rem] font-bold text-sm border btn-active">üîÑ ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô</button>
            <button id="btnSave" onclick="selectAcc('Savings')" class="flex-1 py-4 rounded-[1.6rem] font-bold text-sm border btn-inactive">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏≠‡∏°</button>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button id="typeInc" onclick="selectType('Income')" class="py-4 rounded-3xl font-bold text-sm border-2 border-emerald-500 text-emerald-600 bg-white">‚úö ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
            <button id="typeExp" onclick="selectType('Expense')" class="py-4 rounded-3xl font-bold text-sm border-2 border-rose-500 bg-rose-500 text-white shadow-md">‚ûñ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm space-y-4 border border-slate-50">
            
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-widest">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                <select id="catId" class="w-full p-4 bg-slate-50 rounded-3xl border-none outline-none font-medium appearance-none">
                    <option value="">-- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà... --</option>
                </select>
            </div>

            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-widest">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                <input type="number" id="amount" placeholder="0.00" class="w-full p-4 bg-slate-50 rounded-3xl border-none outline-none text-3xl font-bold text-slate-800">
            </div>

            <div><label class="text-[10px] font-bold text-slate-400 uppercase ml-2 tracking-widest">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥</label>
            <input type="text" id="note" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." class="w-full p-4 bg-slate-50 rounded-3xl border-none outline-none font-medium"></div>

            <div class="pt-2"><label class="block w-full border-2 border-dashed border-slate-200 rounded-3xl p-4 text-center cursor-pointer hover:bg-slate-50 transition" id="imgPreview">
                <input type="file" id="imgInp" class="hidden" accept="image/*" onchange="handleImg(this)"><span class="text-2xl">üì∏</span><br><span class="text-[10px] font-bold text-slate-400 uppercase">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</span>
            </label></div>

            <button id="submitBtn" onclick="submitData()" class="w-full bg-slate-800 text-white py-5 rounded-[2rem] font-bold text-lg shadow-xl active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwLWvfg86IeiMxjcGEyb4BeDyCgpvRJW0rP3rHejeZa_BCN5k9qleV1lcwz-CVQ2lWw/exec";
        let currentAcc = 'Circular', currentType = 'Expense', allCats = [], imgBase64 = null;

        async function init() {
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'get_categories' }) });
                const data = await res.json();
                if(data.status === 'success') { allCats = data.categories; filterCats(); }
            } catch (e) { console.error("Error loading categories"); }
        }

        function filterCats() {
            const sel = document.getElementById('catId');
            sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>';
            const filtered = allCats.filter(c => c.parent === currentAcc && c.type === currentType);
            filtered.forEach(c => { sel.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
            if(filtered.length === 0) sel.innerHTML = '<option value="">-- ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>';
        }

        function selectAcc(v) { 
            currentAcc = v; 
            document.getElementById('btnCirc').className = v === 'Circular' ? "flex-1 py-4 rounded-[1.6rem] font-bold text-sm border btn-active" : "flex-1 py-4 rounded-[1.6rem] font-bold text-sm border btn-inactive";
            document.getElementById('btnSave').className = v === 'Savings' ? "flex-1 py-4 rounded-[1.6rem] font-bold text-sm border btn-active" : "flex-1 py-4 rounded-[1.6rem] font-bold text-sm border btn-inactive";
            filterCats(); 
        }

        function selectType(v) { 
            currentType = v; 
            document.getElementById('typeInc').className = v === 'Income' ? "py-4 rounded-3xl font-bold text-sm border-2 border-emerald-500 bg-emerald-500 text-white shadow-md" : "py-4 rounded-3xl font-bold text-sm border-2 border-emerald-500 text-emerald-600 bg-white";
            document.getElementById('typeExp').className = v === 'Expense' ? "py-4 rounded-3xl font-bold text-sm border-2 border-rose-500 bg-rose-500 text-white shadow-md" : "py-4 rounded-3xl font-bold text-sm border-2 border-rose-500 text-rose-600 bg-white";
            filterCats(); 
        }

        function handleImg(i) { 
            if(i.files && i.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    imgBase64 = e.target.result; 
                    document.getElementById('imgPreview').innerHTML = `<img src="${imgBase64}" class="h-24 mx-auto rounded-xl shadow-md border-2 border-white">`; 
                }; 
                reader.readAsDataURL(i.files[0]); 
            } 
        }

        async function submitData() {
            const amountVal = document.getElementById('amount').value;
            const catId = document.getElementById('catId').value;
            if(!amountVal || !catId) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
            const user = JSON.parse(localStorage.getItem('userData'));
            const btn = document.getElementById('submitBtn'); btn.disabled = true; btn.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            try {
                const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'add_transaction', data: { userId: user.userId, amount: currentType==='Expense' ? -Math.abs(amountVal) : Math.abs(amountVal), catId: catId, note: document.getElementById('note').value, accType: currentAcc, imageFile: imgBase64 } }) });
                const result = await res.json();
                if(result.status === 'success') window.location.href = 'dashboard.html';
                else { alert("‚ùå " + result.message); btn.disabled = false; btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"; }
            } catch (e) { alert("‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ"); btn.disabled = false; btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ"; }
        }
        window.onload = init;
    </script>
</body>
</html>
