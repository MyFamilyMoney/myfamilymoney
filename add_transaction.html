<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏á‡∏¥‡∏ô</title><script src="https://cdn.tailwindcss.com"></script>
    <style>body { font-family: 'Kanit', sans-serif; }</style>
</head>
<body class="bg-gray-50 min-h-screen p-4 flex items-center">
    <div class="max-w-md w-full mx-auto bg-white p-6 rounded-[2.5rem] shadow-xl border">
        <div class="flex bg-gray-100 p-1 rounded-2xl mb-4">
            <button onclick="changeType('Expense')" id="btnExp" class="flex-1 py-3 rounded-xl font-bold bg-white shadow text-red-600 text-sm">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
            <button onclick="changeType('Income')" id="btnInc" class="flex-1 py-3 rounded-xl font-bold text-gray-400 text-sm">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
        </div>

        <form id="transForm" class="space-y-4">
            <select id="accType" class="w-full p-4 border rounded-2xl bg-blue-50 font-bold text-blue-700 outline-none">
                <option value="Circular">üí≥ ‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô (‡∏´‡∏±‡∏Å‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô)</option>
                <option value="Savings">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Å‡πá‡∏ö (‡∏ó‡∏≠‡∏á/‡∏•‡∏á‡∏ó‡∏∏‡∏ô/‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)</option>
            </select>
            <select id="mainCat" onchange="filterSub()" required class="w-full p-4 border rounded-2xl bg-gray-50 text-sm"></select>
            <select id="catId" required class="w-full p-4 border rounded-2xl bg-gray-50 text-sm"></select>
            <input type="number" id="amount" placeholder="0.00" required class="w-full p-4 border rounded-2xl text-3xl text-center font-black text-green-600 outline-none">
            <input type="text" id="note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" class="w-full p-4 border rounded-2xl bg-gray-50 text-sm">
            <button type="submit" id="saveBtn" class="w-full bg-green-600 text-white py-5 rounded-3xl font-bold shadow-lg active:scale-95 transition">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            <button type="button" onclick="window.location.href='dashboard.html'" class="w-full text-gray-400 text-sm">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </form>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxxR_ewzPI6qonh5tQNZz0o1Gek4M_ylU2jqXxlIXrHP0ns6ppC1hR9SXCIw6jY2PFF/exec";
        let currentType = 'Expense'; let allCats = [];

        async function load() {
            const res = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'get_categories' }) });
            const data = await res.json();
            if (data.status === 'success') { allCats = data.categories; renderMain(); }
        }
        function renderMain() {
            const filtered = allCats.filter(c => c.type === currentType);
            const unique = [...new Set(filtered.map(c => c.parent))];
            document.getElementById('mainCat').innerHTML = '<option value="">-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å --</option>' + unique.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('catId').innerHTML = '<option value="">-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>';
        }
        function filterSub() {
            const p = document.getElementById('mainCat').value;
            const subs = allCats.filter(c => c.type === currentType && c.parent === p);
            document.getElementById('catId').innerHTML = '<option value="">-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ --</option>' + subs.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        function changeType(t) {
            currentType = t;
            document.getElementById('btnExp').className = t === 'Expense' ? "flex-1 py-3 rounded-xl font-bold bg-white shadow text-red-600 text-sm" : "flex-1 py-3 rounded-xl font-bold text-gray-400 text-sm";
            document.getElementById('btnInc').className = t === 'Income' ? "flex-1 py-3 rounded-xl font-bold bg-white shadow text-green-600 text-sm" : "flex-1 py-3 rounded-xl font-bold text-gray-400 text-sm";
            renderMain();
        }
        document.getElementById('transForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = JSON.parse(localStorage.getItem('userData'));
            const payload = { action: 'add_transaction', data: { userId: user.userId, catId: document.getElementById('catId').value, amount: document.getElementById('amount').value, note: document.getElementById('note').value, type: currentType, accType: document.getElementById('accType').value } };
            document.getElementById('saveBtn').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) });
            window.location.href = 'dashboard.html';
        });
        window.onload = load;
    </script>
</body>
</html>
